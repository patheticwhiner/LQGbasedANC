# ARMAX 模型分析与控制器设计工具

## 1. 概述

本 MATLAB 脚本 `preparemodel.m` 是一个全面的系统辨识后分析工具，用于将通过系统辨识得到的 ARMAX (Auto-Regressive Moving Average with eXogenous input) 模型转换为状态空间形式，并基于此设计观测器和状态反馈控制器。

## 2. 理论基础

### 2.1 ARMAX 模型

ARMAX 模型是一种多项式模型，其数学形式为：

```
A(q⁻¹)y(t) = B(q⁻¹)u(t) + C(q⁻¹)e(t)
```

其中：
- `A(q⁻¹) = 1 + a₁q⁻¹ + a₂q⁻² + ... + aₙₐq⁻ⁿᴬ` 是自回归多项式
- `B(q⁻¹) = b₁q⁻¹ + b₂q⁻² + ... + bₙᴃq⁻ⁿᴃ` 是输入多项式  
- `C(q⁻¹)` 是噪声多项式
- `q⁻¹` 是后向移位算子
- `e(t)` 是白噪声

### 2.2 能观标准型 (Observable Canonical Form)

能观标准型是状态空间表示的一种特殊形式，其特点是：

1. **系统矩阵 Aₒ**：
   ```
   Aₒ = [-a₁  1   0  ...  0]
        [-a₂  0   1  ...  0]
        [⋮    ⋮   ⋮   ⋱   ⋮]
        [-aₙ  0   0  ...  0]
   ```

2. **输入矩阵 Bₒ**：
   ```
   Bₒ = [b₁]
        [b₂]
        [⋮ ]
        [bₙ]
   ```

3. **输出矩阵 Cₒ**：
   ```
   Cₒ = [1  0  0  ...  0]
   ```

**优势**：
- 能观性矩阵具有简单的结构
- 直接从传递函数系数构造
- 适合观测器设计

### 2.3 能观性理论

#### 2.3.1 能观性定义
一个系统 `(A, C)` 是能观的，当且仅当能观性矩阵：
```
Oₒ = [C; CA; CA²; ...; CA^(n-1)]
```
满秩，即 `rank(Oₒ) = n`。

#### 2.3.2 极零对消与能观性
对于传递函数 `G(z) = B(z)/A(z)`：
- 系统能观 ⟺ `A(z)` 和 `B(z)` 互质
- 如果存在公因子，则对应的模态不能观

### 2.4 能控性理论

#### 2.4.1 能控性定义
一个系统 `(A, B)` 是能控的，当且仅当能控性矩阵：
```
Cₜᵣᵦ = [B  AB  A²B  ...  A^(n-1)B]
```
满秩，即 `rank(Cₜᵣᵦ) = n`。

#### 2.4.2 PBH (Popov-Belevitch-Hautus) 测试
对于系统的每个特征值 `λᵢ`：
- 能控 ⟺ `rank([λᵢI - A, B]) = n`
- 能观 ⟺ `rank([λᵢI - A; C]) = n`

这比直接计算能控/能观性矩阵更精确，特别是对于高阶系统。

### 2.5 观测器设计理论

#### 2.5.1 Luenberger 观测器
观测器动态方程：
```
x̂̇ = Ax̂ + Bu + L(y - Cx̂)
```

其中 `L` 是观测器增益矩阵，观测器特征多项式为 `det(sI - A + LC)`。

#### 2.5.2 极点配置法
通过选择期望的观测器极点 `p₁, p₂, ..., pₙ`，使用 `place` 命令计算：
```matlab
L = place(A', C', desired_poles)'
```

#### 2.5.3 LQR/Kalman 滤波器方法
通过最小化代价函数：
```
J = E[∫₀^∞ (x^T Q x + v^T R v) dt]
```

其中 `v` 是过程噪声，`Q` 和 `R` 分别是状态和测量噪声的权重矩阵。

**优势**：
- 自动保证稳定性
- 对模型不确定性有更好的鲁棒性
- 避免了极点配置中的数值问题

### 2.6 状态反馈控制器设计

#### 2.6.1 状态反馈律
控制律形式：
```
u = -Kx + Nᵦₐᵣr
```

其中：
- `K` 是状态反馈增益矩阵
- `Nᵦₐᵣ` 是前馈增益
- `r` 是参考信号

#### 2.6.2 LQR 方法
最小化二次型代价函数：
```
J = ∫₀^∞ (x^T Q x + u^T R u) dt
```

通过求解代数 Riccati 方程获得最优增益 `K`。

#### 2.6.3 分离原理
对于线性系统，观测器和控制器可以独立设计：
- 首先设计状态反馈控制器（假设状态可测）
- 然后设计观测器估计状态
- 最终的输出反馈控制器：`u = -Kx̂ + Nᵦₐᵣr`

增广系统的特征值是控制器特征值和观测器特征值的并集。

## 3. 脚本功能详解

### 3.1 模型导入与预处理
```matlab
load('ARMAX_SYSID_30303022.mat');
A_poly = ARMAXmodel.model.A;
B_poly = ARMAXmodel.model.B;
```

从 `.mat` 文件中加载预先辨识的 ARMAX 模型，提取多项式系数。

### 3.2 能观标准型转换
```matlab
Ao = zeros(nA);
Ao(:, 1) = -a_coeffs;
Ao(1:nA-1, 2:nA) = eye(nA-1);
```

将 ARMAX 传递函数转换为能观标准型状态空间表示。

### 3.3 互质性验证
```matlab
[is_coprime, gcd_poly, common_roots, analysis] = check_coprimality(A_poly, B_poly);
```

**功能**：
- 使用两种方法验证 `A(z)` 和 `B(z)` 是否互质
- **方法1**：计算最大公约式 (GCD)
- **方法2**：比较多项式根的距离
- 输出共同根位置和分析结果

**理论意义**：
- 互质性直接决定系统的能观性
- 非互质意味着存在极零对消，对应的模态不能观

### 3.4 能观性分析
```matlab
obsv_matrix = obsv(Ao, Co);
rank_obsv = rank(obsv_matrix);
cond_obsv = cond(obsv_matrix);
```

**检查项目**：
- 能观性矩阵的秩
- 条件数（数值稳定性指标）
- 高条件数表示系统"几乎"不能观

### 3.5 观测器设计
```matlab
L_lqr = lqr(Ao', Co', Q_obs, R_obs)';
```

**设计方法**：
- **LQR/Kalman 方法**：更稳健，推荐用于高阶系统
- **极点配置法**：直观但可能数值不稳定

**参数调节**：
- `Q_obs`：状态噪声权重，增大使观测器更相信测量
- `R_obs`：测量噪声权重，增大使观测器更相信模型

### 3.6 能控性分析与控制器设计
```matlab
ctrb_matrix = ctrb(Ao, Bo);
[K_lqr, ~, lqr_cl_poles] = lqr(Ao, Bo, Q_ctrl, R_ctrl);
```

**设计参数**：
- `Q_ctrl`：状态权重矩阵，影响响应速度
- `R_ctrl`：控制输入权重，影响控制成本

### 3.7 前馈增益计算
```matlab
Nbar = 1 / (Co * inv(eye(nA) - Ao + Bo*K) * Bo);
```

确保对阶跃参考信号的稳态跟踪误差为零。

### 3.8 开环系统分析
生成四个关键图表：
1. **零极点图**：显示系统稳定性和动态特性
2. **阶跃响应**：时域瞬态特性
3. **脉冲响应**：系统内在模态
4. **波特图**：频域特性

## 4. 数值问题与解决方案

### 4.1 常见问题
1. **高阶系统的数值不稳定性**
2. **极点配置失败** (`place` 命令错误)
3. **LQR 失败** (黎卡提方程无解)
4. **能观/能控性矩阵病态**

### 4.2 解决策略
1. **优先使用 LQR 方法**：比极点配置更稳健
2. **条件数检查**：识别数值问题
3. **互质性验证**：确保模型的理论正确性
4. **模型降阶**：当原模型存在严重数值问题时

## 5. 使用指南

### 5.1 运行前准备
1. 确保 `ARMAX_SYSID_30303022.mat` 文件存在
2. 检查 MATLAB 工具箱：Control System Toolbox
3. 可选：Symbolic Math Toolbox（用于精确 GCD 计算）

### 5.2 参数调节建议
```matlab
% 观测器设计
Q_obs = eye(nA) * 10;  % 增大以提高观测器响应速度
R_obs = 1;             % 增大以提高噪声抑制

% 控制器设计  
Q_ctrl = eye(nA);      % 增大以提高系统响应速度
R_ctrl = 1;            % 增大以降低控制输入幅度
```

### 5.3 输出解释
- `design_results` 结构体包含所有设计结果
- 图形显示开环系统特性
- 控制台输出提供详细的分析信息

## 6. 扩展应用

### 6.1 鲁棒性分析
可以通过修改模型参数来测试控制器对模型不确定性的敏感度。

### 6.2 性能优化
通过调节 LQR 权重矩阵来平衡：
- 响应速度 vs 控制成本
- 噪声抑制 vs 跟踪性能

### 6.3 实际实现
`design_results` 可用于后续的仿真验证和实际控制器实现。

## 7. 理论参考

1. Kailath, T. "Linear Systems" - 状态空间理论基础
2. Åström, K. J. & Murray, R. M. "Feedback Systems" - 控制理论
3. Ljung, L. "System Identification" - 系统辨识理论
4. Anderson, B. D. O. & Moore, J. B. "Optimal Control" - LQR 理论